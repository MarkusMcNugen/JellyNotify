{#
  Upgraded Item Jinja2 Discord Webhook Template for Jellynouncer
  ===============================================================

  This template generates Discord embed messages for upgraded media items.
  Shows what changed and includes enriched metadata from multiple sources.

  Metadata Source Priority:
  ------------------------
  - TV Shows/Episodes: TVDb → Jellyfin base properties
  - Movies: TMDb → OMDb → Jellyfin base properties

  Change Types Supported:
  ----------------------
  - resolution: Video resolution upgrade
  - codec: Video codec change
  - audio_codec: Audio codec upgrade
  - audio_channels: Channel configuration upgrade
  - hdr_status: HDR upgrade
  - file_size: File replacement
#}
{
  "embeds": [
    {
      {#
        Dynamic Title with Upgrade Type
        --------------------------------
        Shows specific upgrade type when only one change occurred
      #}
      "title": "⬆️ {% if item.item_type == 'Episode' -%}
        📺 Episode
      {%- elif item.item_type == 'Series' -%}
        📺 Series
      {%- elif item.item_type == 'Movie' -%}
        🎬 Movie
      {%- elif item.item_type == 'Season' -%}
        📺 Season
      {%- elif item.item_type == 'Audio' -%}
        🎵 Song
      {%- elif item.item_type == 'MusicAlbum' -%}
        💿 Album
      {%- else -%}
        📁 {{ item.item_type }}
      {%- endif %} {% if changes|length == 1 %}{{ changes[0].type|title }} {% endif %}Upgraded",

      {#
        Rich Description with Metadata Priority
        ----------------------------------------
        Same metadata source priority as new_item template
      #}
      "description": "{% if item.item_type == 'Episode' -%}
        **{{ item.series_name | default('Unknown Series') }}**
        S{{ '%02d' | format(item.season_number | default(0)) }}E{{ '%02d' | format(item.episode_number | default(0)) }}
        {{ item.name | default('Unknown Episode') }}
        {%- if item.tvdb and item.tvdb.overview and item.tvdb.overview | length > 0 -%}
          \n\n{{ (item.tvdb.overview[:200] + '...') if item.tvdb.overview | length > 200 else item.tvdb.overview }}
        {%- elif item.overview and item.overview | length > 0 -%}
          \n\n{{ (item.overview[:200] + '...') if item.overview | length > 200 else item.overview }}
        {%- endif -%}
      {%- elif item.item_type in ['Series', 'Season'] -%}
        **{{ item.name | default('Unknown Title') }}**
        {%- if item.year %} ({{ item.year }}){% endif -%}
        {%- if item.tvdb and item.tvdb.overview and item.tvdb.overview | length > 0 -%}
          \n\n{{ (item.tvdb.overview[:200] + '...') if item.tvdb.overview | length > 200 else item.tvdb.overview }}
        {%- elif item.overview and item.overview | length > 0 -%}
          \n\n{{ (item.overview[:200] + '...') if item.overview | length > 200 else item.overview }}
        {%- endif -%}
      {%- elif item.item_type == 'Movie' -%}
        **{{ item.name | default('Unknown Title') }}**
        {%- if item.year %} ({{ item.year }}){% endif -%}
        {%- if item.tmdb and item.tmdb.overview and item.tmdb.overview | length > 0 -%}
          \n\n{{ (item.tmdb.overview[:200] + '...') if item.tmdb.overview | length > 200 else item.tmdb.overview }}
        {%- elif item.omdb and item.omdb.plot and item.omdb.plot != 'N/A' -%}
          \n\n{{ (item.omdb.plot[:200] + '...') if item.omdb.plot | length > 200 else item.omdb.plot }}
        {%- elif item.overview and item.overview | length > 0 -%}
          \n\n{{ (item.overview[:200] + '...') if item.overview | length > 200 else item.overview }}
        {%- endif -%}
      {%- else -%}
        **{{ item.name | default('Unknown Title') }}**
        {%- if item.overview and item.overview | length > 0 -%}
          \n\n{{ (item.overview[:200] + '...') if item.overview | length > 200 else item.overview }}
        {%- endif -%}
      {%- endif %}",

      "color": {{ color }},

      "fields": [
        {%- set fields_added = namespace(count=0) -%}

        {#
          Upgrade Changes Display
          ------------------------
          Shows what was upgraded with before → after format
        #}
        {% if changes and changes | length > 0 %}
          {% for change in changes[:3] %}
            {% if fields_added.count > 0 %},{% endif %}
            {% set fields_added.count = fields_added.count + 1 %}
          {
            "name": "{% if change.type == 'resolution' -%}
              📐 Resolution Upgrade
            {%- elif change.type == 'codec' -%}
              🎞️ Video Codec Upgrade
            {%- elif change.type == 'audio_codec' -%}
              🔊 Audio Codec Upgrade
            {%- elif change.type == 'audio_channels' -%}
              🔊 Channel Upgrade
            {%- elif change.type == 'hdr_status' -%}
              🌈 HDR Upgrade
            {%- elif change.type == 'file_size' -%}
              💾 File Replaced
            {%- else -%}
              🔄 {{ change.type | title }}
            {%- endif %}",
            "value": "{{ change.old_value or 'Unknown' }} → **{{ change.new_value or 'Unknown' }}**",
            "inline": true
          }
          {% endfor %}
          {% if changes | length > 3 and fields_added.count < 24 %}
            {% if fields_added.count > 0 %},{% endif %}
            {% set fields_added.count = fields_added.count + 1 %}
          {
            "name": "➕ Additional Changes",
            "value": "+{{ changes | length - 3 }} more upgrades",
            "inline": true
          }
          {% endif %}
        {% endif %}

        {#
          Current Technical Specifications
          ---------------------------------
          Shows the new/current specs after upgrade
        #}
        {% if item.video_height and item.item_type not in ['Audio', 'MusicAlbum', 'MusicArtist'] and fields_added.count < 24 %}
          {% if fields_added.count > 0 %},{% endif %}
          {% set fields_added.count = fields_added.count + 1 %}
        {
          "name": "📐 Current Quality",
          "value": "{{ item.video_height }}p
            {%- if item.video_range and item.video_range != 'SDR' %} {{ item.video_range }}{% endif %}",
          "inline": true
        }
        {% endif %}

        {% if item.video_codec and item.item_type not in ['Audio', 'MusicAlbum', 'MusicArtist'] and fields_added.count < 24 %}
          {% if fields_added.count > 0 %},{% endif %}
          {% set fields_added.count = fields_added.count + 1 %}
        {
          "name": "🎞️ Video",
          "value": "{{ item.video_codec | upper }}
            {%- if item.video_profile %} {{ item.video_profile }}{% endif %}",
          "inline": true
        }
        {% endif %}

        {% if item.audio_codec and fields_added.count < 24 %}
          {% if fields_added.count > 0 %},{% endif %}
          {% set fields_added.count = fields_added.count + 1 %}
        {
          "name": "🔊 Audio",
          "value": "{{ item.audio_codec | upper }}
            {%- if item.audio_channels %}
              {%- if item.audio_channels == 2 %} Stereo
              {%- elif item.audio_channels == 6 %} 5.1
              {%- elif item.audio_channels == 8 %} 7.1
              {%- else %} {{ item.audio_channels }}ch
              {%- endif -%}
            {%- endif %}",
          "inline": true
        }
        {% endif %}

        {% if item.file_size and fields_added.count < 24 %}
          {% if fields_added.count > 0 %},{% endif %}
          {% set fields_added.count = fields_added.count + 1 %}
        {
          "name": "💾 New Size",
          "value": "{{ '%.1f' | format(item.file_size / 1073741824) }} GB",
          "inline": true
        }
        {% endif %}

        {#
          Inline Ratings Display
          ----------------------
          All ratings on one line separated by bullets
        #}
        {% set has_ratings = false %}
        {% if (item.omdb and (item.omdb.imdb_rating or item.omdb.metascore or
               item.omdb.ratings_dict.rotten_tomatoes)) or
               (item.tmdb and item.tmdb.vote_average) or
               (item.tvdb and item.tvdb.rating) %}
          {% set has_ratings = true %}
        {% endif %}

        {% if has_ratings and fields_added.count < 24 %}
          {% if fields_added.count > 0 %},{% endif %}
          {% set fields_added.count = fields_added.count + 1 %}
        {
          "name": "⭐ Ratings",
          "value": "
            {%- set rating_parts = [] -%}
            {%- if item.omdb and item.omdb.imdb_rating and item.omdb.imdb_rating != 'N/A' -%}
              {%- set _ = rating_parts.append('**IMDb:** ' ~ item.omdb.imdb_rating) -%}
            {%- endif -%}
            {%- if item.omdb and item.omdb.ratings_dict.rotten_tomatoes -%}
              {%- set _ = rating_parts.append('**RT:** ' ~ item.omdb.ratings_dict.rotten_tomatoes.value) -%}
            {%- endif -%}
            {%- if item.omdb and item.omdb.metascore and item.omdb.metascore != 'N/A' -%}
              {%- set _ = rating_parts.append('**MC:** ' ~ item.omdb.metascore) -%}
            {%- endif -%}
            {%- if item.tmdb and item.tmdb.vote_average -%}
              {%- set _ = rating_parts.append('**TMDb:** ' ~ item.tmdb.vote_average) -%}
            {%- elif item.omdb and item.omdb.ratings_dict.tmdb -%}
              {%- set _ = rating_parts.append('**TMDb:** ' ~ item.omdb.ratings_dict.tmdb.value) -%}
            {%- endif -%}
            {%- if item.tvdb and item.tvdb.rating -%}
              {%- set _ = rating_parts.append('**TVDb:** ' ~ item.tvdb.rating) -%}
            {%- endif -%}
            {{ rating_parts | join(' • ') }}",
          "inline": false
        }
        {% endif %}
      ],

      {# Image selection with priority #}
      {% if item.item_type == 'Episode' and item.series_id %}
      "thumbnail": {
        "url": "{{ thumbnail_url }}"
      },
      {% elif item.item_id %}
      "thumbnail": {
        "url": "{{ thumbnail_url }}"
      },
      {% elif item.omdb and item.omdb.poster and item.omdb.poster != 'N/A' %}
      "thumbnail": {
        "url": "{{ item.omdb.poster }}"
      },
      {% elif item.tvdb and item.tvdb.poster_url %}
      "thumbnail": {
        "url": "{{ item.tvdb.poster_url }}"
      },
      {% elif item.tmdb and item.tmdb.backdrop_url %}
      "image": {
        "url": "{{ item.tmdb.backdrop_url }}"
      },
      {% endif %}

      "footer": {
        "text": "{{ item.library_name or 'Jellyfin' }}
          {%- if item.server_name %} • {{ item.server_name }}{% endif %}
          {%- if item.omdb %} • IMDb via OMDb{% endif %}
          {%- if item.tvdb %} • TheTVDB{% endif %}
          {%- if item.tmdb %} • TMDb{% endif %}",
        "icon_url": "{{ jellyfin_url }}/web/favicon.png"
      },

      {% if item.item_id %}
      "url": "{{ jellyfin_url }}/web/index.html#!/details?id={{ item.item_id }}",
      {% endif %}

      "timestamp": "{{ timestamp }}"
    }
  ]
}