{#
  New Items By Event Template for Jellynouncer
  =============================================

  Groups multiple new items into a single notification.
  Shows basic info for each item with metadata enhancement.

  Optimized for: Multiple items added at once
  Discord limits: Respects field count and character limits
#}
{
  "embeds": [
    {
      "title": "🆕 {{ total_items }} New Items Added",

      "description": "The following items have been added to Jellyfin:",

      "color": 65280,

      "fields": [
        {% set field_count = namespace(value=0) %}

        {#
          Process each item with metadata
          --------------------------------
          Limit to 20 items to stay within field limits
        #}
        {% for item_data in new_items[:20] %}
          {% if field_count.value > 0 %},{% endif %}
          {% set field_count.value = field_count.value + 1 %}
        {
          "name": "{{ item_data.item.item_type }}: {{ (item_data.item.name[:200] + '...')
            if item_data.item.name|length > 200 else item_data.item.name }}",

          "value": "
            {%- if item_data.item.item_type == 'Episode' -%}
              {{ item_data.item.series_name }} S{{ '%02d'|format(item_data.item.season_number or 0) }}E{{ '%02d'|format(item_data.item.episode_number or 0) }}
            {%- endif -%}

            {%- if item_data.item.video_height -%}
              \n📐 {{ item_data.item.video_height }}p
              {%- if item_data.item.video_range and item_data.item.video_range != 'SDR' %} {{ item_data.item.video_range }}{% endif -%}
            {%- endif -%}

            {%- if item_data.item.video_codec -%}
              • 🎞️ {{ item_data.item.video_codec | upper }}
            {%- endif -%}

            {%- if item_data.item.audio_codec -%}
              • 🔊 {{ item_data.item.audio_codec | upper }}
            {%- endif -%}

            {#
              Add primary rating if available
              --------------------------------
              Priority: IMDb → TMDb → TVDb
            #}
            {%- if item_data.item.omdb and item_data.item.omdb.imdb_rating and item_data.item.omdb.imdb_rating != 'N/A' -%}
              \n⭐ IMDb: {{ item_data.item.omdb.imdb_rating }}
            {%- elif item_data.item.tmdb and item_data.item.tmdb.vote_average -%}
              \n⭐ TMDb: {{ item_data.item.tmdb.vote_average }}
            {%- elif item_data.item.tvdb and item_data.item.tvdb.rating -%}
              \n⭐ TVDb: {{ item_data.item.tvdb.rating }}
            {%- endif %}",

          "inline": true
        }
        {% endfor %}

        {% if new_items|length > 20 %}
          {% if field_count.value > 0 %},{% endif %}
        {
          "name": "➕ Additional Items",
          "value": "And {{ new_items|length - 20 }} more items...",
          "inline": false
        }
        {% endif %}
      ],

      "footer": {
        "text": "Jellyfin
          {%- if new_items[0].item.server_name %} • {{ new_items[0].item.server_name }}{% endif %}
          {%- set has_omdb = new_items | selectattr('item.omdb') | list | length > 0 -%}
          {%- set has_tvdb = new_items | selectattr('item.tvdb') | list | length > 0 -%}
          {%- set has_tmdb = new_items | selectattr('item.tmdb') | list | length > 0 -%}
          {%- if has_omdb %} • IMDb via OMDb{% endif -%}
          {%- if has_tvdb %} • TheTVDB{% endif -%}
          {%- if has_tmdb %} • TMDb{% endif %}",
        "icon_url": "{{ jellyfin_url }}/web/favicon.png"
      },

      "timestamp": "{{ timestamp }}"
    }
  ]
}